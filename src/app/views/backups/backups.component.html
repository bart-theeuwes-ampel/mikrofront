<c-row>
  <c-col xs>
    <c-card class="mb-4">
      <c-card-header>
        <c-row class="align-items-center">
          <c-col xs [lg]="6">
            <div class="d-flex align-items-center">
              <h5 class="mb-0 me-3"><i class="fa-solid fa-database me-2"></i>Backups</h5>
              <c-badge color="warning" *ngIf="devid!=0" class="fs-6">
                <i class="fa-solid fa-filter me-1"></i>Device ID {{devid}}
              </c-badge>
            </div>
          </c-col>
          <c-col xs [lg]="6">
            <div class="d-flex justify-content-end align-items-center gap-2">
              <!-- Compare Selection Panel -->
              <div *ngIf="compareitems.length > 0" class="compare-panel me-2">
                <div class="d-flex align-items-center gap-2">
                  <c-badge color="info" class="fs-6">
                    <i class="fa-solid fa-code-compare me-1"></i>{{compareitems.length}} Selected
                  </c-badge>
                  <div class="selected-items d-flex gap-1">
                    <c-badge color="secondary" *ngFor="let item of compareitems; index as i" 
                      class="selected-item d-flex align-items-center">
                      <span class="me-1">{{item.devname}}</span>
                      <i class="fa-solid fa-times cursor-pointer" (click)="delete_compare(i)" 
                        title="Remove from comparison"></i>
                    </c-badge>
                  </div>
                  <button *ngIf="compareitems.length > 1" (click)="start_compare()" 
                    cButton color="success" size="sm">
                    <i class="fa-solid fa-code-compare me-1"></i>Compare
                  </button>
                  <button (click)="clearAllCompare()" cButton color="secondary" size="sm" variant="outline">
                    <i class="fa-solid fa-trash me-1"></i>Clear
                  </button>
                </div>
              </div>
              <!-- Filter Toggle -->
              <button (click)="toggleCollapse()" cButton color="primary" variant="outline">
                <i class="fa-solid fa-filter me-1"></i>Filters
                <i class="fa-solid" [class]="filters_visible ? 'fa-chevron-up' : 'fa-chevron-down'" 
                  style="margin-left: 0.5rem; font-size: 0.8rem;"></i>
              </button>
            </div>
          </c-col>
        </c-row>
      </c-card-header>
      <c-card-body>
        <!-- Enhanced Filter Panel -->
        <div [visible]="filters_visible" cCollapse class="mb-3">
          <c-card class="border-0 bg-light">
            <c-card-body class="py-3">
              <c-row class="g-3 align-items-end">
                <c-col xs="12" md="4">
                  <div class="filter-group">
                    <label class="form-label fw-semibold mb-2">
                      <i class="fa-solid fa-calendar-days me-1 text-primary"></i>Start Date
                    </label>
                    <mat-form-field appearance="outline" class="w-100">
                      <input matInput [matDatepicker]="picker1" (dateChange)="reinitgrid('start',$event)"
                        [(ngModel)]="filters['start_time']" placeholder="Select start date" />
                      <mat-datepicker-toggle matIconSuffix [for]="picker1"></mat-datepicker-toggle>
                      <mat-datepicker #picker1></mat-datepicker>
                    </mat-form-field>
                  </div>
                </c-col>
                <c-col xs="12" md="4">
                  <div class="filter-group">
                    <label class="form-label fw-semibold mb-2">
                      <i class="fa-solid fa-calendar-days me-1 text-primary"></i>End Date
                    </label>
                    <mat-form-field appearance="outline" class="w-100">
                      <input matInput [matDatepicker]="picker2" (dateChange)="reinitgrid('end',$event)"
                        [(ngModel)]="filters['end_time']" placeholder="Select end date" />
                      <mat-datepicker-toggle matIconSuffix [for]="picker2"></mat-datepicker-toggle>
                      <mat-datepicker #picker2></mat-datepicker>
                    </mat-form-field>
                  </div>
                </c-col>
                <c-col xs="12" md="4" *ngIf="ispro">
                  <div class="filter-group">
                    <label class="form-label fw-semibold mb-2">
                      <i class="fa-solid fa-magnifying-glass me-1 text-primary"></i>Config Search
                    </label>
                    <mat-form-field appearance="outline" class="w-100">
                      <input (ngModelChange)="reinitgrid('search',$event)" [(ngModel)]="filters['search']" 
                        matInput placeholder="Search in configurations...">
                    </mat-form-field>
                  </div>
                </c-col>
              </c-row>
            </c-card-body>
          </c-card>
        </div>
        <gui-grid [source]="source" [paging]="paging" [columnMenu]="columnMenu" [sorting]="sorting"
          [infoPanel]="infoPanel" [columnMenu]="columnMenu" [sorting]="sorting" [infoPanel]="infoPanel"
          [autoResizeWidth]=true>
          <gui-grid-column header="#No" type="NUMBER" field="index" width=25 align="CENTER">
            <ng-template let-value="item.index" let-item="item" let-index="index">
              {{value}}
            </ng-template>
          </gui-grid-column>
          <gui-grid-column header="Device Name" field="devname">
            <ng-template let-value="item.devname" let-item="item" let-index="index">
              {{value}}
            </ng-template>
          </gui-grid-column>
          <gui-grid-column header="Device IP" field="devip">
            <ng-template let-value="item.devip" let-item="item" let-index="index">
              {{value}}
            </ng-template>
          </gui-grid-column>
          <gui-grid-column header="backup Time" field="createdC">
            <ng-template let-value="item.createdC" let-item="item" let-index="index">
              {{value}}
            </ng-template>
          </gui-grid-column>
          <gui-grid-column header="File Size" field="filesize">
            <ng-template let-value="item.filesize" let-item="item" let-index="index">
              {{value}}
            </ng-template>
          </gui-grid-column>
          <gui-grid-column header="MAC" field="devmac" [enabled]="false">
            <ng-template let-value="item.devmac" let-item="item" let-index="index">
              {{value}}
            </ng-template>
          </gui-grid-column>
          <gui-grid-column header="Actions" field="id" width="280">
            <ng-template let-value="item.id" let-item="item" let-index="index">
              <div class="d-flex gap-1">
                <button cButton [disabled]="backuploading" color="primary" size="sm" 
                  (click)="ShowBackup(item)" variant="outline" title="View backup content">
                  <i *ngIf="backuploading && currentBackup?.id === item.id" 
                    class="fa-solid fa-spinner fa-spin me-1"></i>
                  <i *ngIf="!backuploading || currentBackup?.id !== item.id" 
                    class="fa-solid fa-eye me-1"></i>
                  View
                </button>
                <button *ngIf="ispro" cButton color="info" size="sm" variant="outline"
                  (click)="add_for_compare(item)" title="Add to comparison"
                  [disabled]="isInCompareList(item)">
                  <i class="fa-solid fa-code-compare me-1"></i>
                  {{isInCompareList(item) ? 'Added' : 'Compare'}}
                </button>
                <button *ngIf="ispro" cButton color="warning" size="sm" variant="outline"
                  (click)="restore_backup(false, false, item)" title="Restore this backup">
                  <i class="fa-solid fa-rotate-left me-1"></i>
                  Restore
                </button>
              </div>
            </ng-template>
          </gui-grid-column>
        </gui-grid>
      </c-card-body>
    </c-card>
  </c-col>
</c-row>

<c-modal #BakcupModal backdrop="static" [(visible)]="BakcupModalVisible" id="BakcupModal" [fullscreen]="true">
  <c-modal-header>
    <h6 cModalTitle>Please Confirm Action </h6>
    <button [cModalToggle]="BakcupModal.id" cButtonClose></button>
  </c-modal-header>
  <c-modal-body>
    <!-- <pre style="height: 100%;">
    <code *ngIf="!loading" language="yaml" style="height:70vh" [highlight]="codeForHighlightAuto" 
    lineNumbers></code></pre> -->
    <div highlight-js [lang]="hlang" [options]="{}"  >{{codeForHighlightAuto}}</div>

  </c-modal-body>
  <c-modal-footer style="justify-content: space-between;">
    <button [cdkCopyToClipboard]="codeForHighlightAuto" [style.background-color]="copy_msg ? 'green' : null" (click)="copy_this()" cButton color="secondary">
      <i class="fa-regular fa-copy"></i> To clipboard
    </button>
    <div>
      <button *ngIf="ispro" (click)="restore_backup(false)" class=" mx-3" cButton color="danger">
        Restore this
      </button>
      <button [cModalToggle]="BakcupModal.id" cButton color="info">
        Close
      </button>
    </div>
  </c-modal-footer>
</c-modal>

<c-modal #CompareModal backdrop="static" [(visible)]="CompareModalVisible" [fullscreen]="true" id="CompareModal">
  <c-modal-header>
    <h6 cModalTitle>Comparing Configs </h6>
    <c-form-check (click)="switch_compare_type()" sizing="xl" class="mx-5" switch>
      <h6>
        <input cFormCheckInput [checked]="compare_type=='unified'"
          style="width: 2.5rem;margin-left: -2.8em;cursor: pointer;" type="checkbox" />

        <label cFormCheckLabel style="padding-top: calc((1.8em - 1rem) / 2);">
          <span *ngIf="compare_type=='sided'">Sided compare</span>
          <span *ngIf="compare_type=='unified'">Unified compare</span>
        </label>
      </h6>
    </c-form-check>
    <button [cModalToggle]="CompareModal.id" cButtonClose></button>
  </c-modal-header>
  <c-modal-body *ngIf="comparecontents.length>1">
    <h5>
      Comparing <c-badge color="dark" style="font-size: 0.8rem;">{{compareitems[0].id}}:{{compareitems[0].devname}}
        {{compareitems[0].createdC}} </c-badge> With
      <c-badge color="dark" style="font-size: 0.8rem;">{{compareitems[1].id}}:{{compareitems[1].devname}}
        {{compareitems[1].createdC}} </c-badge>
    </h5>
    <ngx-unified-diff *ngIf="compare_type=='unified'" class="ngx-diff-light-theme" [before]="comparecontents[0]"
      [after]="comparecontents[1]" />
    <ngx-side-by-side-diff *ngIf="compare_type=='sided'" class="ngx-diff-light-theme" [before]="comparecontents[0]"
      [after]="comparecontents[1]" />
  </c-modal-body>
  <c-modal-footer>
    <button [cModalToggle]="CompareModal.id" cButton color="info">
      Close
    </button>
  </c-modal-footer>
</c-modal>

<!-- Initial Restore Confirmation -->
<c-modal #ConfirmModal backdrop="static" [(visible)]="ConfirmModalVisible" id="runConfirmModal">
  <c-modal-header class="bg-warning text-dark">
    <h5 cModalTitle><i class="fa-solid fa-exclamation-triangle me-2"></i>Confirm Backup Restore</h5>
    <button [cModalToggle]="ConfirmModal.id" cButtonClose></button>
  </c-modal-header>
  <c-modal-body class="p-4">
    <div class="text-center mb-3">
      <i class="fa-solid fa-rotate-left fa-3x text-warning mb-3"></i>
      <h6>Restore Configuration Backup</h6>
    </div>
    
    <div class="backup-info bg-light p-3 rounded mb-3">
      <h6 class="mb-2"><i class="fa-solid fa-info-circle me-2 text-primary"></i>Backup Details</h6>
      <div class="row">
        <div class="col-6"><strong>Device:</strong> {{currentBackup?.devname}}</div>
        <div class="col-6"><strong>IP:</strong> {{currentBackup?.devip}}</div>
        <div class="col-6"><strong>Date:</strong> {{currentBackup?.createdC}}</div>
        <div class="col-6"><strong>Size:</strong> {{currentBackup?.filesize}}</div>
      </div>
    </div>

    <c-alert color="danger" class="mb-0">
      <h6 class="alert-heading"><i class="fa-solid fa-warning me-2"></i>Critical Warning</h6>
      <p class="mb-2">This action will completely reset the device configuration:</p>
      <ul class="mb-0">
        <li>All current device configuration will be overwritten</li>
        <li>All state data and history on router will be reset</li>
        <li>All other local users on router will be deleted</li>
        <li>Device will reboot and apply the restored configuration</li>
      </ul>
    </c-alert>
  </c-modal-body>
  <c-modal-footer class="d-flex justify-content-between">
    <button cButton [cModalToggle]="ConfirmModal.id" color="secondary">
      <i class="fa-solid fa-times me-1"></i>Cancel
    </button>
    <button *ngIf="ispro" (click)="restore_backup(true, false)" cButton color="warning">
      <i class="fa-solid fa-arrow-right me-1"></i>Continue to Final Confirmation
    </button>
  </c-modal-footer>
</c-modal>

<!-- Critical Double Confirmation -->
<c-modal #CriticalConfirmModal backdrop="static" [(visible)]="CriticalConfirmModalVisible" id="CriticalConfirmModal">
  <c-modal-header class="bg-danger text-white">
    <h5 cModalTitle><i class="fa-solid fa-skull-crossbones me-2"></i>CRITICAL: Final Confirmation Required</h5>
  </c-modal-header>
  <c-modal-body class="p-4">
    <div class="text-center mb-4">
      <i class="fa-solid fa-exclamation-triangle fa-4x text-danger mb-3"></i>
      <h5 class="text-danger">DESTRUCTIVE ACTION</h5>
      <p class="mb-0">You are about to permanently overwrite device configuration</p>
    </div>

    <div class="confirmation-box bg-light border border-danger p-3 rounded">
      <p class="mb-3 fw-bold">To proceed with this critical action, type <code>CONFIRM</code> in the box below:</p>
      <input cFormControl [(ngModel)]="confirmationText" placeholder="Type CONFIRM to proceed" 
        class="form-control text-center fw-bold" style="letter-spacing: 2px;" />
    </div>

    <c-alert color="info" class="mt-3 mb-0">
      <small><i class="fa-solid fa-info-circle me-1"></i>
        This confirmation ensures you understand the critical nature of this operation.
      </small>
    </c-alert>
  </c-modal-body>
  <c-modal-footer class="d-flex justify-content-between">
    <button (click)="cancelCriticalRestore()" cButton color="secondary">
      <i class="fa-solid fa-times me-1"></i>Cancel
    </button>
    <button (click)="restore_backup(true, true)" cButton color="danger" 
      [disabled]="confirmationText !== 'CONFIRM'">
      <i class="fa-solid fa-rotate-left me-1"></i>RESTORE BACKUP
    </button>
  </c-modal-footer>
</c-modal>

<c-toaster position="fixed" placement="top-end"></c-toaster>